<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Çè„ÇäÁÆó„Éû„Çπ„Çø„Éº</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { 
            font-family: 'M PLUS Rounded 1c', sans-serif; 
            margin: 0; padding: 0; 
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            min-height: 100vh; overflow: hidden;
            user-select: none; -webkit-tap-highlight-color: transparent;
            display: flex; flex-direction: column;
        }
        .glass { background: rgba(255, 255, 255, 0.45); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 4px 16px rgba(31, 38, 135, 0.1); }
        .hidden { display: none !important; }
        .btn-active:active { transform: scale(0.96); filter: brightness(0.9); }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes rockShake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-3px) rotate(-3deg); } 75% { transform: translateX(3px) rotate(3deg); } }
        .animate-shake { animation: rockShake 0.1s linear infinite; }
        .rock-fragment { position: absolute; background: #4b5563; border: 1px solid #1f2937; z-index: 50; pointer-events: none; }
        @keyframes fragmentFly { 0% { transform: translate(0, 0) rotate(0deg) scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) rotate(var(--tr)) scale(0.5); opacity: 0; } }
        .firework-particle { position: absolute; width: 8px; height: 8px; border-radius: 50%; pointer-events: none; z-index: 100; box-shadow: 0 0 6px currentColor; }
        @keyframes explode { 0% { transform: translate(0, 0) scale(1); opacity: 1; } 100% { transform: translate(var(--dx), var(--dy)) scale(0); opacity: 0; } }
        .path-hanamaru { stroke-dasharray: 1500; stroke-dashoffset: 1500; animation: drawHanamaru 2s ease-out forwards; }
        @keyframes drawHanamaru { to { stroke-dashoffset: 0; } }
        .confetti { position: absolute; animation: fallConfetti 4s linear infinite; pointer-events: none; z-index: 50; }
        @keyframes fallConfetti { 0% { transform: translateY(-20px) rotate(0); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }

        /* „ÉÜ„É≥„Ç≠„ÉºÈÖçÁΩÆ */
        .numpad-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; padding-bottom: 4px; }
        .ok-btn-cell { grid-row: span 2; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.25rem; border-radius: 12px; }

        /* Ë™çÂÆöË®º„Çπ„Çø„Ç§„É´ */
        .cert-container { 
            position: relative; 
            width: 100%; 
            max-width: 600px; 
            margin: 0 auto; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
            border-radius: 8px; 
            overflow: hidden; 
            user-select: auto; 
        }
        .cert-bg { width: 100%; height: auto; display: block; }
        
        .cert-input {
            position: absolute;
            background: transparent;
            border: 1px dashed rgba(0,0,0,0.0);
            font-family: sans-serif;
            font-weight: bold;
            color: #111;
            padding: 0 2px;
            line-height: 1.1;
            z-index: 10;
        }
        .cert-input:focus { 
            background: rgba(255, 255, 255, 0.9); 
            border: 1px solid #3b82f6; 
            outline: none; 
        }

        /* ÂÜôÁúü„Ç®„É™„Ç¢ */
        .cert-photo-area {
            position: absolute;
            background: #f3f4f6;
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
            z-index: 5;
            cursor: pointer;
        }
        .cert-photo-img { width: 100%; height: 100%; object-fit: cover; }
        .cert-photo-placeholder { text-align: center; color: #9ca3af; pointer-events: none; }
    </style>
</head>
<body class="p-2 flex justify-center items-center">

    <div id="app-root" class="max-w-md mx-auto w-full h-[100dvh] flex flex-col relative transition-transform pb-2">
        
        <!-- „Çø„Éñ -->
        <div class="flex bg-white/40 backdrop-blur-md rounded-full p-1 mb-2 shadow-sm flex-none h-10">
            <button id="nav-challenge" onclick="switchTab('challenge')" class="flex-1 rounded-full text-xs font-bold transition-all bg-indigo-500 text-white shadow-md">„ÉÅ„É£„É¨„É≥„Ç∏</button>
            <button id="nav-record" onclick="switchTab('record')" class="flex-1 rounded-full text-xs font-bold transition-all text-indigo-700">„Åç„Çç„Åè</button>
        </div>

        <!-- ÁîªÈù¢1Ôºö„É°„Éã„É•„Éº -->
        <div id="scr-menu" class="screen glass rounded-3xl p-4 text-center flex-1 flex flex-col justify-between overflow-y-auto no-scrollbar">
            <div class="space-y-3 relative">
                <h1 class="text-lg font-black text-indigo-800 flex justify-center items-center gap-2 mt-1">
                    <i data-lucide="calculator" class="w-5 h-5"></i> „Çè„ÇäÁÆó„Å´„Å°„Çá„ÅÜ„Åõ„ÇìÔºÅ
                </h1>

                <!-- ÂêçÂâçÂÖ•Âäõ -->
                <div class="bg-white/50 p-2 rounded-xl border border-white/60">
                    <input type="text" id="user-name-input" placeholder="„Åä„Å™„Åæ„Åà (‰æã: 3-1 „Åü„Çç„ÅÜ)" 
                           class="w-full bg-transparent text-center font-bold text-indigo-900 placeholder-indigo-300 outline-none"
                           oninput="saveName()">
                </div>
                
                <div id="dan-buttons-area" class="grid grid-cols-4 gap-2"></div>
                
                <!-- „É¢„Éº„ÉâÂàáÊõøÔºà„ÅÇ„Åæ„Çä„Å™„Åó / „ÅÇ„Åæ„Çä„ÅÇ„ÇäÔºâ -->
                <div class="flex gap-1 bg-white/30 p-1 rounded-xl">
                    <button class="mode-btn flex-1 py-2 rounded-lg font-bold text-xs transition-all bg-purple-600 text-white shadow-sm" onclick="setMode('NO_REM', this)">„ÅÇ„Åæ„Çä„Å™„Åó</button>
                    <button class="mode-btn flex-1 py-2 rounded-lg font-bold text-xs transition-all text-purple-800 hover:bg-white/50" onclick="setMode('HAS_REM', this)">„ÅÇ„Åæ„Çä„ÅÇ„Çä</button>
                </div>
                
                <button onclick="startGame('stage')" class="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-2xl font-black text-lg shadow-lg btn-active flex items-center justify-center gap-2">
                    <i data-lucide="play" class="w-5 h-5 fill-current"></i> „Çπ„Çø„Éº„ÉàÔºÅ
                </button>
            </div>

            <div class="space-y-2 border-t-2 border-indigo-100 pt-3 flex-none">
                <div class="grid grid-cols-2 gap-2">
                    <button id="btn-sp-25" onclick="startGame('range', '25')" class="py-3 rounded-xl font-bold text-xs shadow-sm border-2 border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed relative" disabled>
                        <span class="flex items-center justify-center gap-1"><i data-lucide="lock" class="w-3 h-3"></i> √∑2„Äú√∑5</span>
                    </button>
                    <button id="btn-sp-69" onclick="startGame('range', '69')" class="py-3 rounded-xl font-bold text-xs shadow-sm border-2 border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed relative" disabled>
                        <span class="flex items-center justify-center gap-1"><i data-lucide="lock" class="w-3 h-3"></i> √∑6„Äú√∑9</span>
                    </button>
                </div>
                <div class="relative h-14" id="last-challenge-box">
                    <div id="rock-layer" class="absolute inset-0 z-20 flex items-center justify-center bg-gradient-to-br from-[#6b7280] to-[#374151] border-4 border-[#1f2937] rounded-xl shadow-lg cursor-pointer" onclick="tryCrumble()" style="clip-path: polygon(2% 10%, 98% 2%, 95% 90%, 5% 98%); transition: transform 0.1s;">
                        <div class="text-gray-300 font-black text-[10px] uppercase tracking-widest flex flex-col items-center"><i data-lucide="lock" class="w-4 h-4 mb-1"></i>Legendary Seal</div>
                    </div>
                    <button id="btn-sp-last" onclick="startGame('last')" class="w-full h-full rounded-xl font-black text-xs shadow-md border-2 border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed relative" disabled>
                        <span class="flex items-center justify-center gap-1"><i data-lucide="lock" class="w-3 h-3"></i> „É©„Çπ„Éà„ÉÅ„É£„É¨„É≥„Ç∏</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- ÁîªÈù¢2Ôºö„Ç≤„Éº„É†„Éó„É¨„Ç§ -->
        <div id="screen-game" class="screen hidden flex-1 flex flex-col min-h-0 space-y-2 fade-in">
            <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden shadow-inner">
                <div id="time-bar" class="bg-indigo-500 h-2 rounded-full transition-all duration-1000 ease-linear" style="width: 100%"></div>
            </div>
            <div class="glass rounded-xl p-2 flex justify-between items-center flex-none text-indigo-700 shadow-sm h-12">
                <div class="flex items-center gap-2"><i data-lucide="timer" class="w-5 h-5"></i><span id="display-timer" class="text-2xl font-mono font-bold">30</span></div>
                <div id="display-count" class="px-3 py-1 bg-indigo-100 text-indigo-600 rounded-full text-xs font-bold border border-indigo-200">„ÅÇ„Å® 9 Âïè</div>
            </div>
            
            <div class="glass rounded-2xl flex-1 flex flex-col justify-center items-center text-center shadow-sm relative min-h-0 px-2">
                <div class="text-[10px] text-gray-400 font-bold mb-1 uppercase">Question</div>
                
                <!-- Ââ≤„ÇäÁÆóÁî®„ÅÆÂÖ•ÂäõUI -->
                <div class="flex items-center justify-center gap-1 sm:gap-2 w-full">
                    <span id="q-text" class="text-3xl sm:text-5xl font-black text-indigo-900 shrink-0">28 √∑ 3</span>
                    <span class="text-xl sm:text-2xl text-indigo-300 shrink-0">Ôºù</span>
                    <!-- Á≠î„ÅàÔºàÂïÜÔºâ„ÅÆÊû† -->
                    <div id="a-field" class="min-w-[45px] h-14 border-b-4 border-indigo-500 text-indigo-600 flex items-center justify-center bg-indigo-50/50 rounded-t-lg text-4xl pb-1"></div>
                    <!-- ‰Ωô„Çä„ÅÆ„Äå‚Ä¶„Äç -->
                    <span id="rem-dots" class="text-xl sm:text-2xl text-indigo-300 shrink-0 hidden">‚Ä¶</span>
                    <!-- ‰Ωô„Çä„ÅÆÊû† -->
                    <div id="rem-field" class="min-w-[45px] h-14 border-b-4 border-indigo-500 text-indigo-600 flex items-center justify-center bg-indigo-50/50 rounded-t-lg text-4xl pb-1 hidden"></div>
                </div>
            </div>

            <div class="numpad-container flex-none">
                <button class="glass h-12 rounded-xl font-bold text-xl btn-active text-indigo-900" onclick="inputNum(1)">1</button>
                <button class="glass h-12 rounded-xl font-bold text-xl btn-active text-indigo-900" onclick="inputNum(2)">2</button>
                <button class="glass h-12 rounded-xl font-bold text-xl btn-active text-indigo-900" onclick="inputNum(3)">3</button>
                <button class="glass h-12 rounded-xl flex items-center justify-center bg-rose-50 text-rose-500 btn-active border-rose-100" onclick="deleteNum()"><i data-lucide="delete" class="w-5 h-5"></i></button>
                <button class="glass h-12 rounded-xl font-bold text-xl btn-active text-indigo-900" onclick="inputNum(4)">4</button>
                <button class="glass h-12 rounded-xl font-bold text-xl btn-active text-indigo-900" onclick="inputNum(5)">5</button>
                <button class="glass h-12 rounded-xl font-bold text-xl btn-active text-indigo-900" onclick="inputNum(6)">6</button>
                <button class="ok-btn-cell shadow-lg btn-active" onclick="submitAnswer()">OK</button>
                <button class="glass h-12 rounded-xl font-bold text-xl btn-active text-indigo-900" onclick="inputNum(7)">7</button>
                <button class="glass h-12 rounded-xl font-bold text-xl btn-active text-indigo-900" onclick="inputNum(8)">8</button>
                <button class="glass h-12 rounded-xl font-bold text-xl btn-active text-indigo-900" onclick="inputNum(9)">9</button>
                <div class="col-span-1"></div>
                <button class="glass h-12 rounded-xl font-bold text-xl btn-active text-indigo-900 col-span-2" onclick="inputNum(0)">0</button>
                <div class="col-span-1"></div>
            </div>
        </div>

        <!-- ÁîªÈù¢3ÔºöÁµêÊûú -->
        <div id="screen-result" class="screen hidden glass rounded-3xl p-6 text-center flex-1 flex flex-col justify-center items-center relative overflow-hidden fade-in">
            <div id="fireworks-container" class="absolute inset-0 pointer-events-none z-0"></div>
            <div id="hanamaru-area" class="flex justify-center items-center w-full h-40 mb-4 z-10 relative"></div>
            <div class="z-10 relative w-full">
                <h2 id="result-msg" class="text-3xl font-black text-gray-800 mb-2"></h2>
                <p id="result-sub" class="text-sm font-bold text-gray-500 mb-6"></p>
                <button onclick="backToTitle()" class="w-full py-4 rounded-2xl font-black text-lg shadow-xl bg-indigo-600 text-white btn-active flex items-center justify-center gap-2">
                    <i data-lucide="home" class="w-5 h-5"></i> „Çø„Ç§„Éà„É´„Å∏„ÇÇ„Å©„Çã
                </button>
            </div>
        </div>

        <!-- ÁîªÈù¢4ÔºöË®òÈå≤ -->
        <div id="screen-record" class="screen hidden flex-1 flex flex-col min-h-0 space-y-2 fade-in overflow-hidden">
            <div id="master-badge" class="hidden flex-none text-center py-3 bg-gradient-to-br from-yellow-50 to-white rounded-2xl border-2 border-yellow-300 shadow-sm relative overflow-hidden shrink-0">
                <div id="master-svg" class="flex justify-center mb-1 scale-90 h-20 items-center"></div>
                <p class="text-yellow-600 font-black text-lg relative z-10">üèÜ ‰ºùË™¨„ÅÆ„Çè„ÇäÁÆó„Éû„Çπ„Çø„Éº</p>
                <!-- Ë™çÂÆöË®ºÁô∫Ë°å„Éú„Çø„É≥ -->
                <button onclick="startCertFlow()" class="absolute bottom-2 right-2 bg-yellow-400 text-white text-xs font-bold px-3 py-1 rounded-full shadow hover:bg-yellow-500 z-20 cursor-pointer">Ë™çÂÆöË®º„Çí„Å§„Åè„Çã</button>
            </div>
            <div class="glass p-3 rounded-2xl shadow-sm flex-none">
                <h3 class="text-xs font-black text-indigo-800 mb-2 flex items-center gap-2 border-b border-indigo-100 pb-1"><i data-lucide="star" class="w-3 h-3 text-yellow-500 fill-current"></i> ÁâπÂà•„ÉÅ„É£„É¨„É≥„Ç∏</h3>
                <div class="grid grid-cols-3 gap-2" id="special-badges-grid"></div>
            </div>
            <div class="bg-white/60 rounded-2xl p-3 shadow-md border border-white/50 flex-1 min-h-0 flex flex-col">
                <div class="overflow-y-auto flex-1 no-scrollbar">
                    <table class="w-full text-xs text-center border-collapse">
                        <thead class="sticky top-0 bg-white/80 backdrop-blur-sm">
                            <tr class="text-indigo-400 border-b border-indigo-100">
                                <th class="pb-1 font-bold text-left pl-1">Ââ≤„ÇãÊï∞</th>
                                <th class="pb-1 font-bold">„ÅÇ„Åæ„Çä„Å™„Åó</th>
                                <th class="pb-1 font-bold">„ÅÇ„Åæ„Çä„ÅÇ„Çä</th>
                            </tr>
                        </thead>
                        <tbody id="record-tbody" class="text-gray-600"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ÁîªÈù¢5ÔºöË™çÂÆöË®º‰ΩúÊàê -->
        <div id="screen-cert-maker" class="screen hidden glass rounded-xl p-2 text-center flex-1 flex flex-col justify-start overflow-y-auto no-scrollbar relative">
            <h2 class="text-lg font-black text-indigo-800 mb-2 flex items-center justify-center gap-2">
                <i data-lucide="award" class="w-5 h-5 text-yellow-500"></i> Ë™çÂÆöË®º„Çí„Å§„Åè„Çç„ÅÜ
            </h2>
            <p class="text-[10px] text-gray-500 mb-2">ÊñáÂ≠ó„ÇÑÂÜôÁúü„ÅØ„Çø„ÉÉ„Éó„Åó„Å¶Â§âÊõ¥„Åß„Åç„Åæ„Åô„ÄÇ<br>ÂÆåÊàê„Åó„Åü„Çâ„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà„Çí„Å®„Å£„Å¶„Å≠ÔºÅ</p>

            <!-- Ë™çÂÆöË®ºÊú¨‰Ωì -->
            <div id="cert-node" class="cert-container relative w-full bg-white rounded shadow-xl overflow-hidden">
                <img src="https://raw.githubusercontent.com/byakusen/warizan_masutar/refs/heads/main/warizan_menkyoshou.png" class="cert-bg" alt="Ë™çÂÆöË®ºËÉåÊôØ">
                
                <!-- Ê∞èÂêç -->
                <input type="text" id="in-name" value="" placeholder="„Åä„Å™„Åæ„Åà" class="cert-input" 
                       style="top: 6.1%; left: 18.7%; width: 40%;">
                
                <!-- Â≠¶Ê†°Âêç -->
                <input type="text" id="in-school" value="" placeholder="Â≠¶Ê†°Âêç" class="cert-input" 
                       style="top: 13.1%; left: 18.7%; width: 40%;">
                
                <!-- Â≠¶Âπ¥ -->
                <input type="text" id="in-grade" value="3" class="cert-input" 
                       style="top: 26.5%; left: 19.5%; width: 10%; text-align: center;">
                
                <!-- ÂÜôÁúü„Ç®„É™„Ç¢ -->
                <div id="cert-photo" class="cert-photo-area" onclick="document.getElementById('file-input').click()" 
                     style="top: 36%; left: 71.2%; width: 22%; height: 38%;">
                    
                    <img id="cert-photo-img" class="w-full h-full object-cover hidden">
                    <div id="cert-photo-placeholder" class="text-center text-gray-400">
                        <i data-lucide="camera" class="w-6 h-6 mx-auto mb-1"></i>
                        <span class="text-[8px] block leading-tight">ÂÜôÁúü„Çí<br>„Åà„Çâ„Å∂</span>
                    </div>
                </div>
            </div>

            <!-- Èö†„Åó„Éï„Ç°„Ç§„É´ÂÖ•Âäõ -->
            <input type="file" id="file-input" accept="image/*" class="hidden" onchange="loadPhoto(event)">

            <button onclick="switchTab('record')" class="mt-4 py-2 px-6 rounded-full bg-gray-400 text-white font-bold text-xs shadow-md btn-active">
                „ÇÇ„Å©„Çã
            </button>
        </div>

    </div>

    <!-- Èü≥Ê∫ê -->
    <audio id="se-correct" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
    <audio id="se-wrong" src="https://assets.mixkit.co/active_storage/sfx/255/255-preview.mp3"></audio>
    <audio id="se-fanfare" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>

    <script>
        const STAGES = [2, 3, 4, 5, 6, 7, 8, 9];
        let state = {
            dan: 2, 
            mode: 'NO_REM', 
            gameType: 'stage',
            problems: [], 
            index: 0, 
            inputAns: "", 
            inputRem: "", 
            timer: 30, 
            maxTime: 30,
            intervalId: null, 
            currentKey: "", 
            waitingForCrumble: false,
            isNoRemMode: true // „ÅÇ„Åæ„ÇäÂÖ•ÂäõÊû†„ÇíÂá∫„Åï„Å™„ÅÑ„Åã„Å©„ÅÜ„Åã„ÅÆ„Éï„É©„Ç∞
        };
        let savedRecords = JSON.parse(localStorage.getItem('warizan_records_v1')) || {};
        let savedName = localStorage.getItem('warizan_username') || "";

        const KEY_VIEW = 'warizan_view_state';
        const KEY_CERT_INFO = 'warizan_cert_info_v1';

        window.onload = () => {
            lucide.createIcons();
            document.getElementById('user-name-input').value = savedName;
            
            loadCertInfo();
            renderMenu();
            renderRecords();

            adjustCertFonts();
            window.addEventListener('resize', adjustCertFonts);

            const lastView = localStorage.getItem(KEY_VIEW);
            if (lastView === 'cert-maker') {
                switchTab('record', false);
                startCertFlow();
            } else if (lastView === 'record') {
                switchTab('record');
            } else {
                switchTab('challenge');
            }

            ['in-name', 'in-school', 'in-grade'].forEach(id => {
                document.getElementById(id).addEventListener('input', saveCertInfo);
            });
        };

        function saveName() {
            const val = document.getElementById('user-name-input').value;
            localStorage.setItem('warizan_username', val);
        }

        function adjustCertFonts() {
            const container = document.getElementById('cert-node');
            if (!container) return;
            const w = container.offsetWidth;
            
            document.getElementById('in-name').style.fontSize = (w * 0.04) + 'px';
            document.getElementById('in-school').style.fontSize = (w * 0.035) + 'px';
            document.getElementById('in-grade').style.fontSize = (w * 0.035) + 'px';
            
            const ph = document.getElementById('cert-photo-placeholder');
            if(ph) ph.style.fontSize = (w * 0.02) + 'px';
        }

        function saveViewState(view) {
            localStorage.setItem(KEY_VIEW, view);
        }

        function saveCertInfo() {
            const info = {
                name: document.getElementById('in-name').value,
                school: document.getElementById('in-school').value,
                grade: document.getElementById('in-grade').value
            };
            localStorage.setItem(KEY_CERT_INFO, JSON.stringify(info));
        }

        function loadCertInfo() {
            const infoStr = localStorage.getItem(KEY_CERT_INFO);
            const menuName = localStorage.getItem('warizan_username') || ""; 
            
            if (infoStr) {
                const info = JSON.parse(infoStr);
                document.getElementById('in-name').value = info.name || menuName;
                document.getElementById('in-school').value = info.school || "";
                document.getElementById('in-grade').value = info.grade || "3";
            } else {
                document.getElementById('in-name').value = menuName;
            }
        }

        function startCertFlow() {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('screen-cert-maker').classList.remove('hidden');
            saveViewState('cert-maker');
            adjustCertFonts();
            
            const menuName = document.getElementById('user-name-input').value;
            const currentCertName = document.getElementById('in-name').value;
            if (menuName && !currentCertName) {
                document.getElementById('in-name').value = menuName;
                saveCertInfo();
            }
        }

        function loadPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('cert-photo-img');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    document.getElementById('cert-photo-placeholder').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function switchTab(tabName, shouldSave = true) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            const btnGame = document.getElementById('nav-challenge');
            const btnRec = document.getElementById('nav-record');
            if (tabName === 'challenge') {
                document.getElementById('scr-menu').classList.remove('hidden');
                btnGame.className = "flex-1 rounded-full text-xs font-bold transition-all bg-indigo-500 text-white shadow-md";
                btnRec.className = "flex-1 rounded-full text-xs font-bold transition-all text-indigo-700 hover:bg-white/30";
                if (state.waitingForCrumble) {
                    state.waitingForCrumble = false;
                    checkUnlockAndCrumble();
                } else { renderMenu(); }
            } else {
                document.getElementById('screen-record').classList.remove('hidden');
                renderRecords();
                btnRec.className = "flex-1 rounded-full text-xs font-bold transition-all bg-indigo-500 text-white shadow-md";
                btnGame.className = "flex-1 rounded-full text-xs font-bold transition-all text-indigo-700 hover:bg-white/30";
            }
            if(shouldSave) saveViewState(tabName);
        }

        function backToTitle() {
            document.querySelectorAll('.confetti').forEach(c => c.remove());
            switchTab('challenge');
        }

        function setMode(mode, btn) {
            state.mode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => {
                b.className = "mode-btn flex-1 py-2 rounded-lg font-bold text-xs transition-all text-purple-800 hover:bg-white/50";
            });
            btn.className = "mode-btn flex-1 py-2 rounded-lg font-bold text-xs transition-all bg-purple-600 text-white shadow-sm";
        }

        function setDan(dan) {
            state.dan = dan;
            renderMenu();
        }

        function renderMenu() {
            const container = document.getElementById('dan-buttons-area');
            container.innerHTML = "";
            STAGES.forEach(d => {
                const btn = document.createElement('button');
                btn.innerText = "√∑" + d;
                if (state.dan === d) {
                    btn.className = "py-3 rounded-xl font-black text-sm border-2 border-indigo-400 bg-indigo-500 text-white shadow-md transform scale-105 transition-all";
                } else {
                    btn.className = "py-3 rounded-xl font-bold text-sm border-2 border-transparent bg-white/60 text-indigo-900 hover:bg-white/80 transition-all";
                }
                btn.onclick = () => setDan(d);
                container.appendChild(btn);
            });
            
            const is25Clear = [2,3,4,5].every(d => savedRecords[`stage-${d}-NO_REM`] && savedRecords[`stage-${d}-HAS_REM`]);
            const is69Clear = [6,7,8,9].every(d => savedRecords[`stage-${d}-NO_REM`] && savedRecords[`stage-${d}-HAS_REM`]);
            const isLastClear = savedRecords['range-25'] && savedRecords['range-69'];
            
            updateSpBtn('btn-sp-25', is25Clear, '√∑2„Äú√∑5');
            updateSpBtn('btn-sp-69', is69Clear, '√∑6„Äú√∑9');
            
            const lastBtn = document.getElementById('btn-sp-last');
            const rock = document.getElementById('rock-layer');
            if (isLastClear && !state.waitingForCrumble) {
                lastBtn.disabled = false;
                lastBtn.className = "w-full h-full rounded-xl font-black text-xs shadow-md bg-gradient-to-r from-orange-500 to-rose-500 text-white btn-active relative z-30";
                lastBtn.innerHTML = `<span class="flex items-center justify-center gap-2"><i data-lucide="crown" class="w-4 h-4 fill-white"></i> „É©„Çπ„Éà„ÉÅ„É£„É¨„É≥„Ç∏</span>`;
                if(rock) rock.classList.add('hidden');
            } else {
                lastBtn.disabled = true;
                if(rock) rock.classList.remove('hidden');
            }
            lucide.createIcons();
        }

        function updateSpBtn(id, unlocked, text) {
            const btn = document.getElementById(id);
            if (unlocked) {
                btn.disabled = false;
                btn.className = "py-3 rounded-xl font-bold text-xs shadow-sm border-2 border-indigo-100 bg-white text-indigo-600 btn-active relative";
                btn.innerHTML = `<span class="flex items-center justify-center gap-1"><i data-lucide="star" class="w-3 h-3 text-yellow-400 fill-current"></i> ${text}</span>`;
            } else {
                btn.disabled = true;
                btn.className = "py-3 rounded-xl font-bold text-xs shadow-sm border-2 border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed relative";
                btn.innerHTML = `<span class="flex items-center justify-center gap-1"><i data-lucide="lock" class="w-3 h-3"></i> ${text}</span>`;
            }
        }

        // --- ÂïèÈ°åÁîüÊàê„É≠„Ç∏„ÉÉ„ÇØ ---
        function startGame(type, val) {
            state.gameType = type;
            state.inputAns = "";
            state.inputRem = "";
            
            // „Äå„ÅÇ„Åæ„Çä„Å™„Åó„Äç„ÅÆÊÆµ„Åî„Å®„ÅÆ„ÉÜ„Çπ„Éà„ÅÆÊôÇ„Å†„Åë„ÄÅ‰Ωô„ÇäÊû†„ÇíÂá∫„Åï„Å™„ÅÑË®≠ÂÆö„Å´„Åô„Çã
            state.isNoRemMode = (type === 'stage' && state.mode === 'NO_REM');

            let time = 30;
            let list = [];
            let key = "";
            
            if (type === 'stage') {
                const d = state.dan;
                if (state.mode === 'NO_REM') {
                    for (let i = 1; i <= 9; i++) {
                        list.push({ q: `${d * i} √∑ ${d}`, a: i, rem: 0 });
                    }
                } else {
                    let all = [];
                    for (let i = 1; i <= 9; i++) {
                        for (let r = 0; r < d; r++) { 
                            all.push({ q: `${d * i + r} √∑ ${d}`, a: i, rem: r });
                        }
                    }
                    list = all.sort(() => Math.random() - 0.5).slice(0, 10);
                }
                list.sort(() => Math.random() - 0.5);
                key = `stage-${d}-${state.mode}`;
                time = state.mode === 'NO_REM' ? 30 : 45;
            } else if (type === 'range') {
                const range = val === '25' ? [2,3,4,5] : [6,7,8,9];
                let all = [];
                range.forEach(d => {
                    // ÂÖ®„Å¶„ÅÆÁµÑ„ÅøÂêà„Çè„ÅõÔºà„ÅÇ„Åæ„Çä0„Äú„ÅÇ„Åæ„Çä„ÅÇ„ÇäÔºâ
                    for(let i=1; i<=9; i++) {
                        for(let r=0; r<d; r++) all.push({ q: `${d*i+r} √∑ ${d}`, a: i, rem: r });
                    }
                });
                list = all.sort(() => Math.random() - 0.5).slice(0, 20);
                time = 60;
                key = `range-${val}`;
            } else if (type === 'last') {
                let all = [];
                for(let d=2; d<=9; d++) {
                    for(let i=1; i<=9; i++) {
                        for(let r=0; r<d; r++) all.push({ q: `${d*i+r} √∑ ${d}`, a: i, rem: r });
                    }
                }
                list = all.sort(() => Math.random() - 0.5).slice(0, 30);
                time = 90;
                key = `last-challenge`;
            }
            
            state.problems = list;
            state.index = 0;
            state.timer = time;
            state.maxTime = time;
            state.currentKey = key;
            
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('screen-game').classList.remove('hidden');
            updateDisplay();
            
            if (state.intervalId) clearInterval(state.intervalId);
            state.intervalId = setInterval(() => {
                state.timer--;
                const timerEl = document.getElementById('display-timer');
                const barEl = document.getElementById('time-bar');
                timerEl.innerText = state.timer;
                const pct = (state.timer / state.maxTime) * 100;
                barEl.style.width = pct + '%';
                if (state.timer <= 10) {
                    timerEl.classList.add('text-alert', 'text-rose-500');
                    barEl.classList.add('bg-alert', 'bg-rose-500');
                } else {
                    timerEl.classList.remove('text-alert', 'text-rose-500');
                    barEl.classList.remove('bg-alert', 'bg-rose-500');
                }
                if (state.timer <= 0) finishGame(false);
            }, 1000);
        }

        // --- „Çπ„Éû„Éº„Éà„Å™ÂÖ•ÂäõUI„ÅÆÂà∂Âæ° ---
        function updateDisplay() {
            const p = state.problems[state.index];
            document.getElementById('q-text').innerText = p.q;
            
            const aField = document.getElementById('a-field');
            const remDots = document.getElementById('rem-dots');
            const remField = document.getElementById('rem-field');

            aField.innerText = state.inputAns;
            
            if (state.isNoRemMode) {
                remDots.classList.add('hidden');
                remField.classList.add('hidden');
                
                if (state.inputAns !== "") {
                    aField.className = "min-w-[45px] sm:min-w-[60px] h-14 sm:h-16 border-b-4 border-indigo-200 text-indigo-600 flex items-center justify-center bg-indigo-50/30 rounded-t-lg text-4xl sm:text-5xl pb-1";
                } else {
                    aField.className = "min-w-[45px] sm:min-w-[60px] h-14 sm:h-16 border-b-4 border-rose-500 text-rose-600 flex items-center justify-center bg-rose-50 rounded-t-lg text-4xl sm:text-5xl pb-1";
                }
            } else {
                if (state.inputAns !== "") {
                    remDots.classList.remove('hidden');
                    remField.classList.remove('hidden');
                    remField.innerText = state.inputRem;
                    
                    aField.className = "min-w-[45px] sm:min-w-[60px] h-14 sm:h-16 border-b-4 border-indigo-200 text-indigo-600 flex items-center justify-center bg-indigo-50/30 rounded-t-lg text-4xl sm:text-5xl pb-1";
                    if (state.inputRem === "") {
                        remField.className = "min-w-[45px] sm:min-w-[60px] h-14 sm:h-16 border-b-4 border-rose-500 text-rose-600 flex items-center justify-center bg-rose-50 rounded-t-lg text-4xl sm:text-5xl pb-1";
                    } else {
                        remField.className = "min-w-[45px] sm:min-w-[60px] h-14 sm:h-16 border-b-4 border-indigo-200 text-indigo-600 flex items-center justify-center bg-indigo-50/30 rounded-t-lg text-4xl sm:text-5xl pb-1";
                    }
                } else {
                    remDots.classList.add('hidden');
                    remField.classList.add('hidden');
                    aField.className = "min-w-[45px] sm:min-w-[60px] h-14 sm:h-16 border-b-4 border-rose-500 text-rose-600 flex items-center justify-center bg-rose-50 rounded-t-lg text-4xl sm:text-5xl pb-1";
                    remField.className = "min-w-[45px] sm:min-w-[60px] h-14 sm:h-16 border-b-4 border-indigo-200 text-indigo-600 flex items-center justify-center bg-indigo-50/30 rounded-t-lg text-4xl sm:text-5xl pb-1 hidden";
                }
            }
            
            document.getElementById('display-count').innerText = `„ÅÇ„Å® ${state.problems.length - state.index} Âïè`;
        }

        function inputNum(num) {
            if (state.isNoRemMode) {
                if (state.inputAns === "") {
                    state.inputAns = num.toString();
                }
            } else {
                if (state.inputAns === "") {
                    state.inputAns = num.toString();
                } else if (state.inputRem === "") {
                    state.inputRem = num.toString();
                }
            }
            updateDisplay();
        }

        function deleteNum() {
            if (state.inputRem !== "") {
                state.inputRem = ""; 
            } else if (state.inputAns !== "") {
                state.inputAns = ""; 
            }
            updateDisplay();
        }

        function submitAnswer() {
            if (state.inputAns === "") return;
            
            const p = state.problems[state.index];
            const ans = parseInt(state.inputAns);
            const rem = state.inputRem === "" ? 0 : parseInt(state.inputRem);
            
            if (ans === p.a && rem === p.rem) {
                playAudio('se-correct');
                state.index++;
                state.inputAns = "";
                state.inputRem = "";
                if (state.index >= state.problems.length) finishGame(true);
                else updateDisplay();
            } else {
                playAudio('se-wrong');
                const appRoot = document.getElementById('app-root');
                appRoot.classList.remove('shake-screen');
                void appRoot.offsetWidth;
                appRoot.classList.add('shake-screen');
                finishGame(false);
            }
        }

        function finishGame(isWin) {
            clearInterval(state.intervalId);
            const resScreen = document.getElementById('screen-result');
            const msg = document.getElementById('result-msg');
            const sub = document.getElementById('result-sub');
            const svgBox = document.getElementById('hanamaru-area');
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            resScreen.classList.remove('hidden');
            if (isWin) {
                msg.innerText = "„ÇØ„É™„Ç¢ÔºÅ";
                msg.className = "text-4xl font-black text-rose-500 mb-2";
                sub.innerText = "„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ";
                const wasLocked = !(savedRecords['range-25'] && savedRecords['range-69']);
                
                savedRecords[state.currentKey] = true;
                localStorage.setItem('warizan_records_v1', JSON.stringify(savedRecords));
                
                const isNowUnlocked = savedRecords['range-25'] && savedRecords['range-69'];
                if (wasLocked && isNowUnlocked) {
                    state.waitingForCrumble = true;
                }
                const lbl = (state.currentKey === 'last-challenge') ? "‰ºùË™¨ÈÅîÊàê" : "„Åî„ÅÜ„Åã„Åè";
                svgBox.innerHTML = createHanamaruSVG(220, lbl);
                if (state.currentKey === 'last-challenge') {
                    playAudio('se-fanfare');
                    createConfetti();
                    launchFireworks();
                } else {
                    createConfetti();
                }
            } else {
                msg.innerText = "„Åä„Åó„Åæ„ÅÑ";
                msg.className = "text-4xl font-black text-gray-500 mb-2";
                sub.innerText = "„ÇÇ„ÅÜ„ÅÑ„Å°„Å© „Åå„Çì„Å∞„Çç„ÅÜÔºÅ";
                svgBox.innerHTML = `<div class="bg-gray-100 p-8 rounded-full shadow-inner"><i data-lucide="rotate-ccw" class="w-16 h-16 text-gray-400"></i></div>`;
                lucide.createIcons();
            }
        }

        function playAudio(id) {
            const a = document.getElementById(id);
            a.currentTime = 0;
            a.play().catch(()=>{});
        }

        function createHanamaruSVG(size, label) {
            return `
            <svg width="${size}" height="${size}" viewBox="0 0 200 200">
                <path class="path-hanamaru" d="M100,30 C110,10 135,10 145,30 C165,25 185,45 180,65 C200,75 200,100 180,110 C185,130 165,150 145,145 C135,165 110,165 100,145 C90,165 65,165 55,145 C35,150 15,130 20,110 C0,100 0,75 20,65 C15,45 35,25 55,30 C65,10 90,10 100,30" fill="none" stroke="#f43f5e" stroke-width="10" stroke-linecap="round" />
                <circle class="path-hanamaru" cx="100" cy="85" r="50" fill="none" stroke="#f43f5e" stroke-width="5" />
                <text x="100" y="95" text-anchor="middle" fill="#f43f5e" font-weight="900" font-size="28" style="font-family: 'M PLUS Rounded 1c'">${label}</text>
            </svg>`;
        }

        function createConfetti() {
            const container = document.getElementById('screen-result');
            for(let i=0; i<30; i++){
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random()*100 + '%';
                c.style.backgroundColor = ['#f43f5e','#fbbf24','#3b82f6'][i%3];
                c.style.width = '10px'; c.style.height = '10px';
                c.style.animationDelay = Math.random()*2 + 's';
                container.appendChild(c);
            }
        }

        function renderRecords() {
            const badgeGrid = document.getElementById('special-badges-grid');
            badgeGrid.innerHTML = "";
            [['range-25', '√∑2„Äú√∑5'], ['range-69', '√∑6„Äú√∑9'], ['last-challenge', '„É©„Çπ„Éà']].forEach(([k, n]) => {
                const ok = savedRecords[k];
                const d = document.createElement('div');
                d.className = `p-2 rounded-xl flex flex-col items-center justify-center gap-1 ${ok ? 'bg-yellow-100 text-yellow-600 border border-yellow-300' : 'bg-gray-50 text-gray-300 border border-gray-100'}`;
                d.innerHTML = `<i data-lucide="trophy" class="w-5 h-5 ${ok?'fill-current':''}"></i><span class="text-[10px] font-bold">${n}</span>`;
                badgeGrid.appendChild(d);
            });

            const tbody = document.getElementById('record-tbody');
            tbody.innerHTML = "";
            for(let d=2; d<=9; d++){
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-100 hover:bg-indigo-50/50 transition-colors";
                let h = `<td class="text-left pl-2 font-bold text-indigo-900 py-1.5">√∑${d}</td>`;
                ['NO_REM', 'HAS_REM'].forEach(m => {
                    const ok = savedRecords[`stage-${d}-${m}`];
                    h += `<td class="text-center"><div class="w-5 h-5 mx-auto rounded-full flex items-center justify-center ${ok ? 'bg-indigo-500 text-white' : 'bg-gray-100'}"><i data-lucide="check" class="w-3 h-3 ${ok?'':'hidden'}"></i></div></td>`;
                });
                tr.innerHTML = h;
                tbody.appendChild(tr);
            }

            if(savedRecords['last-challenge']) {
                document.getElementById('master-badge').classList.remove('hidden');
                document.getElementById('master-svg').innerHTML = createHanamaruSVG(150, "„Çè„ÇäÁÆó„ÅÆÁ•û");
            }
            lucide.createIcons();
        }

        function checkUnlockAndCrumble() {
            const rock = document.getElementById('rock-layer');
            if (!rock) return;
            const is25 = [2,3,4,5].every(d => savedRecords[`stage-${d}-NO_REM`] && savedRecords[`stage-${d}-HAS_REM`]);
            const is69 = [6,7,8,9].every(d => savedRecords[`stage-${d}-NO_REM`] && savedRecords[`stage-${d}-HAS_REM`]);
            const isUnlocked = is25 && is69;
            if (isUnlocked && !rock.classList.contains('hidden')) {
                rock.classList.add('animate-rumble');
                playRockSound();
                setTimeout(() => {
                    createRockFragments(rock);
                    rock.classList.add('hidden');
                    const btn = document.getElementById('btn-sp-last');
                    btn.disabled = false;
                    btn.className = "w-full h-full rounded-xl font-black text-xs shadow-xl bg-gradient-to-r from-orange-500 to-rose-500 text-white btn-active relative z-30 animate-pulse";
                    btn.innerHTML = `<span class="flex items-center justify-center gap-2"><i data-lucide="crown" class="w-4 h-4 fill-white"></i> „É©„Çπ„Éà„ÉÅ„É£„É¨„É≥„Ç∏</span>`;
                    lucide.createIcons();
                }, 1000);
            }
        }

        function createRockFragments(rockElem) {
            const container = document.getElementById('last-challenge-box');
            for (let i = 0; i < 30; i++) {
                const fragment = document.createElement('div');
                fragment.className = 'rock-fragment';
                const size = Math.random() * 20 + 8;
                fragment.style.width = size + 'px';
                fragment.style.height = size + 'px';
                fragment.style.left = '50%'; fragment.style.top = '50%';
                const angle = Math.random() * Math.PI * 2;
                const dist = Math.random() * 300 + 100;
                const tx = Math.cos(angle) * dist + 'px';
                const ty = Math.sin(angle) * dist + 'px';
                const tr = (Math.random() - 0.5) * 720 + 'deg';
                fragment.style.setProperty('--tx', tx);
                fragment.style.setProperty('--ty', ty);
                fragment.style.setProperty('--tr', tr);
                fragment.style.animation = 'fragmentFly 1.5s ease-out forwards';
                container.appendChild(fragment);
                setTimeout(() => fragment.remove(), 1500);
            }
        }

        function playRockSound() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(80, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(10, ctx.currentTime + 0.8);
                gain.gain.setValueAtTime(0.5, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.8);
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + 0.8);
            } catch(e) {}
        }

        function launchFireworks() {
            const container = document.getElementById('fireworks-container');
            container.innerHTML = '';
            const colors = ['#f43f5e', '#facc15', '#3b82f6', '#10b981', '#a855f7', '#ff6b6b'];
            for(let i=0; i<25; i++) {
                setTimeout(() => {
                    const cx = Math.random() * 80 + 10;
                    const cy = Math.random() * 50 + 10;
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    for(let j=0; j<20; j++) {
                        const p = document.createElement('div');
                        p.className = 'firework-particle';
                        p.style.backgroundColor = color;
                        p.style.left = cx + '%'; p.style.top = cy + '%';
                        const angle = (j / 20) * 360;
                        const dist = Math.random() * 150 + 80;
                        const dx = Math.cos(angle * Math.PI / 180) * dist + 'px';
                        const dy = Math.sin(angle * Math.PI / 180) * dist + 'px';
                        p.style.setProperty('--dx', dx);
                        p.style.setProperty('--dy', dy);
                        p.style.animation = 'explode 1.2s ease-out forwards';
                        container.appendChild(p);
                        setTimeout(() => p.remove(), 1200);
                    }
                }, i * 200);
            }
        }
    </script>
</body>
</html>